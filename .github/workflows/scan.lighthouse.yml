name: lighthouse
on:
  workflow_dispatch:
  push:
    branches: [$default-branch, gh-pages]
  pull_request:
    branches: [$default-branch, gh-pages]
    types: [opened,assigned,synchronize]
  schedule:
    - cron: '0 10 * * 2'

env:
  ENDPOIND: https://ivankatliarchuk.github.io/knowledge-base

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master

      - name: run lighthouse
        uses: foo-software/lighthouse-check-action@master
        id: lighthouseCheck
        with:
          accessToken: ${{ secrets.GITHUB_TOKEN }}
          tag: GitHub Action
          urls: ${{ env.ENDPOIND }}
          sha: ${{ github.sha }}
          branch: ${{ github.ref }}
          author: ${{ github.actor }}
          outputDirectory: /tmp/artifacts

      - name: handle lighthouse check results
        uses: foo-software/lighthouse-check-status-action@master
        with:
          lighthouseCheckResults: ${{ steps.lighthouseCheck.outputs.lighthouseCheckResults }}
          minAccessibilityScore: "90"
          minBestPracticesScore: "50"
          minPerformanceScore: "50"
          minProgressiveWebAppScore: "50"
          minSeoScore: "50"

      - name: Upload artifacts
        uses: actions/upload-artifact@master
        with:
          name: Lighthouse reports
          path: /tmp/artifacts
          
      # https://github.com/JasonEtco/actions-toolkit#toolscontext
      - name: create issue from file
        uses: JasonEtco/create-an-issue@v2
        id: create-issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ADJECTIVE: ${{ steps.lighthouseCheck.outputs.scores }}
        with:
          filename: ./github/lighthouse.md
          assignees: ${{ github.actor }}
          update_existing: true

      - run: 'echo Created issue number ${{ steps.create-issue.outputs.number }}'
      - run: 'echo Created ${{ steps.create-issue.outputs.url }}'
